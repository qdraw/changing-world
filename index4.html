<!DOCTYPE html>
<meta charset="utf-8">
<head>

<link rel="stylesheet" type="text/css" href="css/style.css">


</head>
<body>



<div id="canvas"></div>

<script type="text/javascript" src="js/tabletop.js"></script>


<script type="text/javascript">


    var data = {};


    // window.onload = function() { init() };

    var public_spreadsheet_url = 'https://docs.google.com/spreadsheets/d/1RKekJPcE5OazkWOWatk04a34HUhOO1nRqIhVaOTtJPk/pubhtml';

    function init() {
        Tabletop.init( { key: public_spreadsheet_url,
            callback: showInfo,
            simpleSheet: true } )
    }

    function showInfo(content, tabletop) {
        // window.requestAnimationFrame(draw);

        console.log(content);

		Object.keys(content).forEach(function(key) {

			data[content[key].code] = new Object();
			// data[content[key].code]["img"] = new Image();
			// data[content[key].code]["img"]["src"] = "images/countries/" + content[key].code + ".svg";

			var image = document.createElement("div");
			// image.setAttribute("src", "images/countries/" + content[key].code + ".svg");
			image.setAttribute("id", content[key].code);


				var xhr = new XMLHttpRequest();
				xhr.onreadystatechange = function() {
				    if (xhr.readyState == 4) {
						var response = xhr.responseText;
						var response = response.replaceAll('#CCCCCC', '#c62c2c');

						var encoded = window.btoa(response);
						image.setAttribute("style", "background-image: url('data:image/svg+xml;base64," + encoded + "')");
				    }
				}
				xhr.open('GET', "images/countries/" + content[key].code + ".svg", true);
				xhr.send(null);


			
			document.getElementById("canvas").appendChild(image);


			data[content[key].code]["x"] = content[key]["x1"];
			data[content[key].code]["y"] = content[key]["y1"];
			data[content[key].code]["s"] = content[key]["s1"];

		});



		requestAnimationFrame(function() {
		    draw(data,content);
		});

    }

    function draw(data,content) {


		Object.keys(content).forEach(function(key) {

			if (data[content[key].code]["x"] < content[key]["x2"]) {
				// console.log("x " + content[key].code + " " + data[content[key].code]["x"]);
				data[content[key].code]["x"]++;
			}
			else {
				data[content[key].code]["x"] = content[key]["x2"];
			}

			if (data[content[key].code]["y"] < content[key]["y2"]) {
				// console.log("y " +data[content[key].code]["y"]);
				data[content[key].code]["y"]++;
			}
			else {
				data[content[key].code]["y"] = content[key]["y2"];
				// console.log(data[content[key].code]["y"])
			}

			// s
			if (data[content[key].code]["s"] < content[key]["s2"]) {
				// console.log("y " +data[content[key].code]["y"]);
				data[content[key].code]["s"]++;
			}
			else {
				data[content[key].code]["s"] = content[key]["s2"];
				// console.log(data[content[key].code]["y"])
			}			



			document.getElementById(content[key].code).style.width = data[content[key].code]["s"] + "vw";
			document.getElementById(content[key].code).style.height = data[content[key].code]["s"] + "vw";



			// document.getElementById(content[key].code).style.height = data[content[key].code]["s"] + "vh";

			document.getElementById(content[key].code).style.left = data[content[key].code]["x"] + "vw";
			document.getElementById(content[key].code).style.top = data[content[key].code]["y"] + "vh";


			// document.getElementById(content[key].code).style.width = data[content[key].code]["s"];
			// document.getElementById(content[key].code).style.height = data[content[key].code]["s"];

			// document.querySelector("#canvas #" + content[key].code).style.left = data[content[key].code]["x"] + " vw";
			// document.querySelector("#canvas #" + content[key].code).style.top = data[content[key].code]["y"] + " vw";


			// ctx.drawImage(data[content[key].code]["img"],data[content[key].code]["x"],data[content[key].code]["y"],data[content[key].code]["s"],data[content[key].code]["s"])

		});

		requestAnimationFrame(function() {
		    draw(data,content);
		});

    }

	String.prototype.replaceAll = function( token, newToken, ignoreCase ) {
	    var _token;
	    var str = this + "";
	    var i = -1;

	    if ( typeof token === "string" ) {

	        if ( ignoreCase ) {

	            _token = token.toLowerCase();

	            while( (
	                i = str.toLowerCase().indexOf(
	                    token, i >= 0 ? i + newToken.length : 0
	                ) ) !== -1
	            ) {
	                str = str.substring( 0, i ) +
	                    newToken +
	                    str.substring( i + token.length );
	            }

	        } else {
	            return this.split( token ).join( newToken );
	        }

	    }
	return str;
	};

    init();
</script>



</body>
</html>